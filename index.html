<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>九州親子賞楓自駕行 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
  <script>
    const { createApp, ref, computed, watch, onMounted } = Vue

    createApp({
        setup() {
            // --- 基礎設定 ---
            const APP_STORAGE_KEY = 'kyushu_trip_2025_v1'; // 儲存金鑰
            const EXCHANGE_RATE = 0.21; 
            const currentTab = ref('itinerary');
            const showModal = ref(false);
            const showSyncModal = ref(false); // 新增：同步視窗控制
            const syncInput = ref('');        // 新增：匯入輸入框
            const modalType = ref(''); 
            const isEditMode = ref(false);
            const selectedDateIndex = ref(0);
            
            // 貨幣計算
            const currencyInput = ref(10000);
            const currencyResult = ref(0);
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * EXCHANGE_RATE);

            // --- 資料定義 (預設值) ---
            const dates = ref([
                { date: '12/13', weekday: '六', hasCar: false, location: '福岡' },
                { date: '12/14', weekday: '日', hasCar: true, location: '福岡 → 熊本' },
                { date: '12/15', weekday: '一', hasCar: true, location: '熊本 → 高千穗' },
                { date: '12/16', weekday: '二', hasCar: true, location: '黑川 → 別府' },
                { date: '12/17', weekday: '三', hasCar: true, location: '別府 → 由布院' },
                { date: '12/18', weekday: '四', hasCar: true, location: '由布院 → 福岡' },
                { date: '12/19', weekday: '五', hasCar: false, location: '福岡 (門司港)' },
                { date: '12/20', weekday: '六', hasCar: false, location: '福岡 (太宰府)' },
                { date: '12/21', weekday: '日', hasCar: false, location: '福岡 → 返台' },
            ]);

            const weatherData = ref([
                { condition: 'cloudy', temp: '12/5' }, 
                { condition: 'sunny', temp: '11/4' },  
                { condition: 'sunny', temp: '8/-1' },  
                { condition: 'cloudy', temp: '7/-2' }, 
                { condition: 'rain', temp: '9/3' },    
                { condition: 'cloudy', temp: '10/4' }, 
                { condition: 'sunny', temp: '11/5' },  
                { condition: 'sunny', temp: '12/6' },  
                { condition: 'cloudy', temp: '12/6' }, 
            ]);

            const hotels = ref([
                { name: 'Cross Life 博多柳橋', date: '12/13 (1晚)', priceTWD: 'NT$21,246', priceJPY: 98818, area: '福岡' },
                { name: 'Hotel Nikko Kumamoto', date: '12/14 (1晚)', priceTWD: 'NT$9,694', priceJPY: 45088, area: '熊本' },
                { name: '山しのぶ (黑川溫泉)', date: '12/15 (1晚)', priceTWD: 'NT$27,407', priceJPY: 127474, area: '黑川' },
                { name: 'AMANEK BEPPU YULA-RE', date: '12/16-18 (2晚)', priceTWD: 'NT$27,914', priceJPY: 129832, area: '別府' },
                { name: 'Tokyu Stay Fukuoka Tenjin', date: '12/18-21 (3晚)', priceTWD: 'NT$60,134', priceJPY: 279693, area: '福岡天神' },
            ]);

            const shoppingList = ref([
                { name: '福岡明太子' }, { name: '努努雞' }, { name: '熊本熊周邊' }, { name: '由布院 B-Speak 蛋糕捲' }, { name: '藥妝 (合利他命)' }
            ]);
            
            const expenses = ref([
                { name: 'Cross Life 博多', amount: 98818, category: 'stay', date: '2025-12-13' },
                { name: '日航熊本', amount: 45088, category: 'stay', date: '2025-12-14' },
                { name: '山しのぶ', amount: 127474, category: 'stay', date: '2025-12-15' },
                { name: 'AMANEK 別府', amount: 129832, category: 'stay', date: '2025-12-16' },
                { name: 'Tokyu Stay 天神', amount: 279693, category: 'stay', date: '2025-12-18' },
            ]);

            // --- 預設行程資料 (若無存檔則使用此份) ---
            const defaultItineraryData = [
                // Day 1
                [
                    { id: 101, category: 'flight', startTime: '06:00', hours: '08:00 - 11:15', name: '前往機場 (桃園 TPE)', note: '飛機 08:00 TPE ~ 11:15 FUK ', transportType: 'flight' },
                    { id: 102, category: 'transport', startTime: '10:00', hours: '10:00 - 11:00', name: '抵達福岡 & 放行李', address: 'Cross Life 博多柳橋', note: '機場搭地鐵往市區 (渡邊通站) ', transportType: 'public', travelTime: '約 30 分鐘 (地鐵)' },
                    { id: 103, category: 'food', startTime: '13:00', hours: '13:00 - 14:00', name: '午餐: The Full Full Hakata', note: '明太子法國麵包 ', transportType: 'walk', travelTime: '約 15 分鐘 (步行)' },
                    { id: 104, category: 'sightseeing', startTime: '14:00', hours: '14:00 - 16:00', name: '福岡市區逛街', note: '博多運河城 (MUJI、一番賞)、櫛田神社、麵包超人博物館 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 105, category: 'food', startTime: '17:00', hours: '17:00 - 18:00', name: '晚餐: 華美鳥水炊鍋', note: '已預約 17:00 ', transportType: 'walk', travelTime: '約 15 分鐘 (步行)' },
                    { id: 106, category: 'food', startTime: '19:00', hours: '19:00 - 20:00', name: '宵夜: ShinShin / 大砲 / 屋台', note: '推薦拉麵與屋台體驗 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                ],
                // Day 2
                [
                    { id: 201, category: 'transport', startTime: '08:00', hours: '08:00 - 09:00', name: '租車 (天神渡邊通店)', address: '天神渡邊通店', note: 'Mapcode: 13 318 076*06\n08:00 取車 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 202, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 11:00', name: '開車行程 (賞楓/銀杏)', note: '太原銀杏森林 (37 292 372*68)\n秋月城跡 (55 173 471*74) ', transportType: 'car', travelTime: '約 50 分鐘 (車)' },
                    { id: 203, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 勝烈亭 豬排', note: 'Mapcode: 29 459 389*34 ', transportType: 'car', travelTime: '約 90 分鐘 (高速)' },
                    { id: 204, category: 'sightseeing', startTime: '14:00', hours: '14:00 - 15:00', name: '熊本城 + 城彩苑', note: 'Mapcode: 29 489 329*60 ', transportType: 'walk', travelTime: '約 10 分鐘 (車)' },
                    { id: 205, category: 'shopping', startTime: '15:00', hours: '15:00 - 16:00', name: '市區逛街 & 喫茶室', note: '上下通商店街、長崎次郎喫茶室 (29 458 566*01) ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 206, category: 'food', startTime: '18:00', hours: '18:00 - 19:30', name: '晚餐: 和牛塔卡 (LIEBE)', note: '已訂位 18:30\nMapcode: 29 460 452*38 ', transportType: 'car', travelTime: '約 15 分鐘 (車)' },
                    { id: 207, category: 'accommodation', startTime: '20:00', name: '住宿: 日航熊本', note: 'Mapcode: 29 490 018*61 ', transportType: 'car', travelTime: '約 10 分鐘 (車)' }
                ],
                // Day 3
                [
                    { id: 301, category: 'other', startTime: '06:00', name: '備註: 確認高千穗划船狀況', note: '確認運行狀況 ', transportType: 'car' },
                    { id: 302, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 10:30', name: '天岩戶神社', note: 'Mapcode: 330 837 641*24 ', transportType: 'car', travelTime: '約 1小時45分 (山路)' },
                    { id: 303, category: 'food', startTime: '11:00', hours: '11:00 - 12:00', name: '午餐: 高千穗牛_和', note: 'Mapcode: 330 742 450*53 ', transportType: 'car', travelTime: '約 15 分鐘 (車)' },
                    { id: 304, category: 'sightseeing', startTime: '12:00', hours: '12:00 - 13:00', name: '高千穗峽 (划船)', note: '預約 12:00\nMapcode: 330 711 671*87 ', transportType: 'car', travelTime: '約 10 分鐘 (車)' },
                    { id: 305, category: 'transport', startTime: '13:00', hours: '13:00 - 14:30', name: '前往上色見', note: '約 1 小時車程 ', transportType: 'car', travelTime: '約 55 分鐘 (山路)' },
                    { id: 306, category: 'sightseeing', startTime: '14:30', hours: '14:30 - 15:30', name: '上色見熊野座神社', note: 'Mapcode: 256 379 371*35 ', transportType: 'car', travelTime: '抵達即開始' },
                    { id: 307, category: 'food', startTime: '18:00', hours: '18:00 - 19:00', name: '晚餐: 飯店懷石料理', note: '18:30 用餐 ', transportType: 'car', travelTime: '約 50 分鐘 (往黑川)' },
                    { id: 308, category: 'sightseeing', startTime: '19:00', hours: '19:00 - 20:00', name: '黑川溫泉街散策', note: '推薦: Patisserie Roku 泡芙 ', transportType: 'walk', travelTime: 'Check-in 後步行' },
                    { id: 309, category: 'accommodation', startTime: '20:00', name: '住宿: 山しのぶ', note: 'Mapcode: 440 540 236*68 ', transportType: 'car', travelTime: '位於溫泉區旁' }
                ],
                // Day 4
                [
                    { id: 401, category: 'other', startTime: '06:00', name: '備註: 確認阿蘇火山開放', note: '確認開放狀況 ', transportType: 'car' },
                    { id: 402, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 11:00', name: '阿蘇火山口', note: '可搭直升機\nMapcode: 256 460 704*02 ', transportType: 'car', travelTime: '約 50 分鐘 (山路)' },
                    { id: 403, category: 'sightseeing', startTime: '12:00', hours: '12:00 - 13:30', name: '午餐 & 草千里', note: '騎馬/散步 ', transportType: 'car', travelTime: '約 5 分鐘 (車)' },
                    { id: 404, category: 'sightseeing', startTime: '14:00', hours: '14:00 - 15:00', name: '阿蘇神社', note: '吃阿蘇牛奶、泡芙\nMapcode: 256 704 305*31 ', transportType: 'car', travelTime: '約 25 分鐘 (下山)' },
                    { id: 405, category: 'transport', startTime: '15:00', hours: '15:00 - 17:00', name: '前往別府', note: '途經 九重夢大橋 / 長者原道標 ', transportType: 'car', travelTime: '約 90 分鐘 (山脈公路)' },
                    { id: 406, category: 'food', startTime: '17:00', hours: '17:00 - 18:00', name: '晚餐: 天婦羅 とよ常', note: 'Mapcode: 46 405 225*67 ', transportType: 'car', travelTime: '抵達別府市區' },
                    { id: 407, category: 'accommodation', startTime: '19:00', name: '住宿: AMANEK BEPPU', note: 'Mapcode: 46 405 228*51 ', transportType: 'car', travelTime: '約 5 分鐘 (車)' }
                ],
                // Day 5
                [
                    { id: 501, category: 'food', startTime: '07:00', hours: '07:00 - 08:30', name: '早餐: Cafe La Ruche', note: '金鱗湖畔\nMapcode: 269 359 616*04 ', transportType: 'car', travelTime: '約 40 分鐘 (別府往由布院)' },
                    { id: 502, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 10:30', name: '別府地獄巡遊', note: '吃地獄蒸布丁\nMapcode: 46 521 469*64 ', transportType: 'car', travelTime: '約 35 分鐘 (折返別府)' },
                    { id: 503, category: 'sightseeing', startTime: '10:30', hours: '10:30 - 11:30', name: '狭霧台 (眺望由布院)', note: 'Mapcode: 46 301 725*70 ', transportType: 'car', travelTime: '約 15 分鐘 (山路)' },
                    { id: 504, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 布釜飯 / 蕎麥麵', note: '由布まぶし 心 或 手打蕎麥麵 泉 ', transportType: 'car', travelTime: '約 15 分鐘 (下山)' },
                    { id: 505, category: 'sightseeing', startTime: '13:00', hours: '13:00 - 15:30', name: '由布院散策', note: '金鱗湖、花卉村、B-speak ', transportType: 'walk', travelTime: '步行逛街' },
                    { id: 506, category: 'food', startTime: '17:00', hours: '17:00 - 18:30', name: '晚餐: 海鮮いづつ', note: '別府市區海鮮\nMapcode: 46 375 716*53 ', transportType: 'car', travelTime: '約 45 分鐘 (回別府)' },
                    { id: 507, category: 'sightseeing', startTime: '19:00', hours: '19:00 - 20:00', name: '湯霧展望台 (夜景)', note: 'Mapcode: 46 523 435*11 ', transportType: 'car', travelTime: '約 15 分鐘 (車)' },
                    { id: 508, category: 'accommodation', startTime: '20:30', name: '住宿: AMANEK BEPPU', note: '續住 ', transportType: 'car', travelTime: '約 15 分鐘 (下山)' }
                ],
                // Day 6
                [
                    { id: 601, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 13:00', name: '九州自然動物園', note: 'Mapcode: 46 634 658*87\n叢林巴士 ', transportType: 'car', travelTime: '約 30 分鐘 (車)' },
                    { id: 602, category: 'sightseeing', startTime: '13:00', hours: '13:00 - 14:00', name: '別府纜車 (備選)', note: 'Mapcode: 46 369 844*81 ', transportType: 'car', travelTime: '約 25 分鐘 (車)' },
                    { id: 603, category: 'transport', startTime: '14:00', hours: '14:00 - 16:30', name: '開車返回福岡', note: '返回市區 ', transportType: 'car', travelTime: '約 2 小時 (高速)' },
                    { id: 604, category: 'transport', startTime: '17:00', hours: '17:00 - 18:00', name: '還車 (天神渡邊通店)', note: '20:00 前需還車 ', transportType: 'car', travelTime: '市區塞車緩衝' },
                    { id: 605, category: 'food', startTime: '18:00', hours: '18:00 - 20:00', name: '晚餐: 博多牛腸鍋', note: '天神周邊自由覓食 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 606, category: 'accommodation', startTime: '20:00', name: '住宿: Tokyu Stay 天神', note: 'Mapcode: 13 318 296*24 ', transportType: 'walk', travelTime: '約 5 分鐘 (步行)' }
                ],
                // Day 7
                [
                    { id: 701, category: 'transport', startTime: '08:00', hours: '08:00 - 09:30', name: '前往門司港 (JR)', note: '博多 > 小倉 > 門司港 ', transportType: 'public', travelTime: '約 10 分鐘 (地鐵)' },
                    { id: 702, category: 'sightseeing', startTime: '10:00', hours: '10:00 - 12:00', name: '門司港懷舊區', note: '車站、舊門司稅關、藍翼橋 ', transportType: 'walk', travelTime: '約 50 分鐘 (JR特急)' },
                    { id: 703, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 伽哩本舖', note: '燒咖哩 ', transportType: 'walk', travelTime: '約 5 分鐘 (步行)' },
                    { id: 704, category: 'sightseeing', startTime: '13:00', hours: '13:00 - 15:00', name: '小倉城 / 勝山公園', note: '賞楓 ', transportType: 'public', travelTime: '約 20 分鐘 (JR)' },
                    { id: 705, category: 'food', startTime: '18:00', hours: '18:00 - 19:30', name: '晚餐: 鰻魚 田舍庵', note: '小倉百年老店 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 706, category: 'accommodation', startTime: '20:00', name: '住宿: Tokyu Stay 天神', note: '續住 ', transportType: 'public', travelTime: '約 50 分鐘 (JR/新幹線)' }
                ],
                // Day 8
                [
                    { id: 801, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 11:00', name: '太宰府天滿宮', note: '光明禪寺、梅枝餅 ', transportType: 'public', travelTime: '約 45 分鐘 (西鐵巴士/電車)' },
                    { id: 802, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 明太子 神樂', note: '神楽 (かぐら) ', transportType: 'walk', travelTime: '參道步行' },
                    { id: 803, category: 'shopping', startTime: '14:00', hours: '14:00 - 17:00', name: 'TeamLab / 福岡塔', note: '沈浸式光影展 / 逛街 ', transportType: 'public', travelTime: '約 50 分鐘 (巴士直達)' },
                    { id: 804, category: 'food', startTime: '18:00', hours: '18:00 - 19:30', name: '晚餐: 燒肉 上', note: 'Yakiniku Jo ', transportType: 'walk', travelTime: '約 20 分鐘 (巴士)' },
                    { id: 805, category: 'accommodation', startTime: '20:00', name: '住宿: Tokyu Stay 天神', note: '續住 ', transportType: 'walk', travelTime: '約 15 分鐘 (步行)' }
                ],
                // Day 9
                [
                    { id: 901, category: 'food', startTime: '06:00', hours: '06:00 - 08:00', name: '早餐巡禮', note: '大砲/一双/ShinShin ', transportType: 'walk', travelTime: '起床出發' },
                    { id: 902, category: 'food', startTime: '08:00', hours: '08:00 - 10:00', name: 'I\'m donut? / Dacomecca', note: '排隊名店 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 903, category: 'sightseeing', startTime: '10:00', hours: '10:00 - 12:00', name: '大濠公園 & LOCALS', note: '最後採買 (努努雞) ', transportType: 'walk', travelTime: '約 20 分鐘 (地鐵)' },
                    { id: 904, category: 'food', startTime: '12:30', hours: '12:30 - 14:00', name: '午餐: 人形町今半', note: '壽喜燒 ', transportType: 'walk', travelTime: '約 20 分鐘 (地鐵)' },
                    { id: 905, category: 'transport', startTime: '17:00', name: '前往機場 (FUK)', note: '準備返台 ', transportType: 'public', travelTime: '約 30 分鐘 (地鐵)' },
                    { id: 906, category: 'flight', startTime: '20:55', name: '飛機起飛', note: '20:55 FUK ~ TPE ', transportType: 'flight', travelTime: 'Check-in 等候' }
                ]
            ];

            const itineraryData = ref(JSON.parse(JSON.stringify(defaultItineraryData)));

            // --- Computed ---
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * EXCHANGE_RATE));

            // 通用變數
            const newItem = ref({ name: '', amount: null, date: '', category: 'food', startTime: '', note: '' });

            // --- 資料存取 (Persistence) ---
            
            // 載入資料
            const loadFromStorage = () => {
                const saved = localStorage.getItem(APP_STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if(parsed.itinerary) itineraryData.value = parsed.itinerary;
                        if(parsed.expenses) expenses.value = parsed.expenses;
                        if(parsed.shopping) shoppingList.value = parsed.shopping;
                        console.log('資料已從本機載入');
                    } catch (e) {
                        console.error('資料載入失敗，使用預設值', e);
                    }
                }
            };

            // 監聽變更並自動儲存
            watch([itineraryData, expenses, shoppingList], () => {
                const dataToSave = {
                    itinerary: itineraryData.value,
                    expenses: expenses.value,
                    shopping: shoppingList.value
                };
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(dataToSave));
            }, { deep: true });

            // --- 匯出匯入功能 (手動同步) ---
            const copyDataToClipboard = () => {
                const dataStr = JSON.stringify({
                    itinerary: itineraryData.value,
                    expenses: expenses.value,
                    shopping: shoppingList.value
                });
                // 簡單加密/編碼以免亂碼
                const encoded = btoa(unescape(encodeURIComponent(dataStr)));
                
                navigator.clipboard.writeText(encoded).then(() => {
                    alert('設定碼已複製！請傳給朋友，請他們點擊「匯入」並貼上。');
                }).catch(() => {
                    alert('複製失敗，請手動複製螢幕上的代碼。');
                    syncInput.value = encoded;
                });
            };

            const importDataString = () => {
                try {
                    if(!syncInput.value) return;
                    const decoded = decodeURIComponent(escape(atob(syncInput.value.trim())));
                    const parsed = JSON.parse(decoded);
                    
                    if(confirm('這將會覆蓋您目前的行程紀錄，確定嗎？')) {
                        if(parsed.itinerary) itineraryData.value = parsed.itinerary;
                        if(parsed.expenses) expenses.value = parsed.expenses;
                        if(parsed.shopping) shoppingList.value = parsed.shopping;
                        showSyncModal.value = false;
                        alert('匯入成功！');
                    }
                } catch (e) {
                    alert('代碼格式錯誤，請確認複製是否完整。');
                    console.error(e);
                }
            };
            
            const openSyncModal = () => {
                showSyncModal.value = true;
                syncInput.value = '';
            };


            // --- 操作 Methods ---
            const handleAddClick = () => {
                modalType.value = currentTab.value;
                newItem.value = { name: '', amount: null, date: dates.value[selectedDateIndex.value].date, category: 'food', startTime: '', note: '', transportType: 'walk' };
                isEditMode.value = false;
                showModal.value = true;
            };

            const saveShoppingItem = () => {
                if(newItem.value.name) shoppingList.value.push({...newItem.value});
                showModal.value = false;
            };
            const removeShoppingItem = (idx) => shoppingList.value.splice(idx, 1);
            
            const saveExpenseItem = () => {
                if(newItem.value.name && newItem.value.amount) expenses.value.push({...newItem.value});
                showModal.value = false;
            };
            const removeExpense = (idx) => expenses.value.splice(idx, 1);

            const saveItineraryItem = () => {
                const list = itineraryData.value[selectedDateIndex.value];
                if(isEditMode.value && newItem.value.id) {
                    // 確保更新 Array 的 Reactivity
                    const idx = list.findIndex(i => i.id === newItem.value.id);
                    if(idx !== -1) {
                        list[idx] = { ...newItem.value }; 
                    }
                } else {
                    list.push({...newItem.value, id: Date.now()});
                }
                showModal.value = false;
            };
            const editItem = (item) => {
                newItem.value = JSON.parse(JSON.stringify(item));
                modalType.value = 'itinerary';
                isEditMode.value = true;
                showModal.value = true;
            };
            const removeItineraryItem = () => {
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === newItem.value.id);
                if(idx !== -1) list.splice(idx, 1);
                showModal.value = false;
            };

            const moveItineraryUp = (id) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === id);
                if(idx > 0) {
                    const temp = list[idx];
                    list[idx] = list[idx-1];
                    list[idx-1] = temp;
                }
            };
            const moveItineraryDown = (id) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === id);
                if(idx < list.length - 1) {
                    const temp = list[idx];
                    list[idx] = list[idx+1];
                    list[idx+1] = temp;
                }
            };

            // Helpers & Map Fixes
            const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
            
            // 修正：單點導航
            const openMap = (q) => {
                if (!q) return;
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            };

            // 修正：區間導航
            const openMapDirections = (startItem, endItem) => {
                if (!startItem || !endItem) return;
                const origin = startItem.address || startItem.name;
                const destination = endItem.address || endItem.name;
                let mode = 'driving'; 
                if (endItem.transportType === 'walk') mode = 'walking';
                if (endItem.transportType === 'public' || endItem.transportType === 'flight') mode = 'transit';

                const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${mode}`;
                window.open(url, '_blank');
            };

            const getCategoryColor = (c) => ({
                sightseeing: 'bg-matcha-green', food: 'bg-maple-red', shopping: 'bg-gingko-gold',
                accommodation: 'bg-stone-600', flight: 'bg-blue-500', transport: 'bg-warm-orange', other: 'bg-stone-400'
            }[c] || 'bg-stone-400');
            
            const getCategoryIcon = (c) => ({
                sightseeing: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping',
                accommodation: 'fa-solid fa-bed', flight: 'fa-solid fa-plane', transport: 'fa-solid fa-car', other: 'fa-solid fa-info'
            }[c] || 'fa-solid fa-circle');

            const getCategoryLabel = (c) => ({ sightseeing: '景點', food: '美食', shopping: '購物', stay: '住宿', transport: '交通' }[c] || '其他');

            const getWeatherIcon = (c) => ({
                sunny: 'fa-solid fa-sun', cloudy: 'fa-solid fa-cloud', rain: 'fa-solid fa-umbrella', snow: 'fa-solid fa-snowflake'
            }[c] || 'fa-solid fa-cloud');
            
            const getWeatherDescription = (c) => ({ sunny: '晴朗', cloudy: '多雲', rain: '有雨', snow: '降雪' }[c] || '未知');

            const getTransportIcon = (t) => ({
                car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking', public: 'fa-solid fa-train', flight: 'fa-solid fa-plane'
            }[t] || 'fa-solid fa-arrow-right');

            onMounted(() => {
                loadFromStorage();
                calculateCurrency();
            });

            return {
                currentTab, dates, selectedDateIndex, currentItinerary, hotels, shoppingList, expenses,
                weatherData, currencyInput, currencyResult, calculateCurrency, totalExpensesJPY, totalExpensesTWD,
                showModal, showSyncModal, syncInput, modalType, isEditMode, newItem,
                handleAddClick, saveShoppingItem, removeShoppingItem, saveExpenseItem, removeExpense,
                saveItineraryItem, editItem, removeItineraryItem, moveItineraryUp, moveItineraryDown,
                formatNumber, openMap, openMapDirections, copyDataToClipboard, importDataString, openSyncModal,
                getCategoryColor, getCategoryIcon, getCategoryLabel, getWeatherIcon, getWeatherDescription, getTransportIcon
            };
        }
    }).mount('#app');
</script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            background-color: #FFF8E1; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #5D4037;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff; 
            box-shadow: 0 0 30px rgba(93, 64, 55, 0.1);
            position: relative;
            padding-bottom: 90px;
        }

        .header-bg {
            background-color: #ffffff;
            padding: 0; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.15);
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px;
            z-index: 10; 
        }
        
        .header-image-container {
            width: 100%;
            height: 250px; 
            overflow: hidden;
            background-color: #FFECB3; 
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px;
            position: relative;
        }
        
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            object-position: center;
            display: block; 
        }

        .leaf-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        .leaf {
            position: absolute;
            top: -20px;
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.7;
            animation-name: leaf-fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .leaf.maple {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23D32F2F'%3E%3Cpath d='M17,12L15.3,10.3L17,7L13.7,8.7L12,7L10.3,8.7L7,7L8.7,10.3L7,12L10.3,13.7L9,17H15L13.7,13.7L17,12Z'/%3E%3C/svg%3E");
        }
        .leaf.gingko {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFA000'%3E%3Cpath d='M12,2C12,2 4,3 4,12C4,16 7,19 7,19L12,22L17,19C17,19 20,16 20,12C20,3 12,2 12,2Z'/%3E%3C/svg%3E");
        }

        @keyframes leaf-fall {
            0% { transform: translateY(-20px) rotate(0deg) translateX(0px); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(300px) rotate(360deg) translateX(50px); opacity: 0; }
        }
        
        .side-tab-bar {
            position: absolute;
            bottom: 45px; 
            right: 16px;
            z-index: 30;
            display: flex;
            flex-direction: row;
            gap: 8px; 
        }
        
        .tab-button {
            width: 40px;
            height: 40px;
            border-radius: 9999px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem; 
            box-shadow: 0 4px 10px rgba(93, 64, 55, 0.2);
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            background-color: #D32F2F; 
            color: #ffffff;
            box-shadow: 0 6px 15px rgba(211, 47, 47, 0.4); 
            transform: scale(1.05);
        }
        
        .tab-button:not(.active) {
            background-color: #ffffff;
            color: #FFB74D; 
        }

        .app-main {
            padding-top: 25px !important;
            position: relative;
            z-index: 5;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card-shadow {
            box-shadow: 0 4px 20px rgba(93, 64, 55, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fab-shadow {
            box-shadow: 0 4px 15px rgba(255, 160, 0, 0.5);
        }

        .note-content {
            max-height: 2.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .note-content.expanded { max-height: 500px; }
        
        .expense-category-tag {
            min-width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .expenses-banner {
            background: linear-gradient(135deg, #D32F2F 0%, #FF6F00 100%);
        }
        
        .date-selector-sticky {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0; 
            z-index: 20; 
            top: 0; 
        }

        .date-active {
            background-color: #D32F2F !important; 
            color: white !important;
            border-color: #D32F2F !important;
        }
        
        .date-inactive {
            background-color: white;
            color: #8D6E63; 
        }
        
        .date-inactive:hover {
            background-color: #FFF3E0;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <div class="header-bg relative">
        <div class="header-image-container relative">
            <img src="banner.jpg" 
                 onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1524413840807-0c3cb6fa808d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80';" 
                 alt="九州賞楓自駕旅">
            
            <div class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-black/40 to-transparent"></div>
            <div class="absolute bottom-6 left-6 text-white">
                <h1 class="text-2xl font-bold shadow-black drop-shadow-md">九州賞楓自駕旅</h1>
                <p class="text-sm opacity-90 drop-shadow-md">2025.12.13 - 12.21</p>
            </div>
        </div>
        
        <div class="leaf-layer" id="leafLayer">
            <div v-for="n in 10" :key="n" class="leaf" 
                 :class="n % 2 === 0 ? 'maple' : 'gingko'"
                 :style="{ 
                    left: Math.random() * 100 + '%', 
                    animationDuration: (5 + Math.random() * 5) + 's', 
                    animationDelay: (Math.random() * 5) + 's' 
                 }">
            </div>
        </div> 
        
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" title="行程" :class="{'active': currentTab === 'itinerary'}" class="tab-button">
                <i class="fa-solid fa-map-location-dot"></i>
            </button>
            <button @click="currentTab = 'info'" title="資訊" :class="{'active': currentTab === 'info'}" class="tab-button">
                <i class="fa-solid fa-circle-info"></i>
            </button>
            <button @click="currentTab = 'shopping'" title="購物" :class="{'active': currentTab === 'shopping'}" class="tab-button">
                <i class="fa-solid fa-basket-shopping"></i>
            </button>
            <button @click="currentTab = 'expenses'" title="花費" :class="{'active': currentTab === 'expenses'}" class="tab-button">
                <i class="fa-solid fa-coins"></i>
            </button>
        </div>
    </div>
    
    <main class="p-4 app-main">
        
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4">
                <div v-for="(day, index) in dates" :key="index" 
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                     :class="selectedDateIndex === index ? 'date-active shadow-lg scale-105' : 'date-inactive border-white'">
                    
                    <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span> 
                    <span class="text-xs font-medium opacity-70">{{ day.date }}</span> 
                </div>
            </div>

            <div v-if="weatherData[selectedDateIndex]" class="mb-4 bg-autumn-cream border border-warm-orange/30 rounded-2xl p-4 flex justify-between items-center shadow-md">
                <div class="flex items-start text-earth-brown space-x-4">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-4xl text-warm-orange"></i>
                    <div class="pt-1">
                        <span class="text-2xl font-extrabold leading-none">{{ weatherData[selectedDateIndex].temp }}°C</span>
                        <span class="block text-xs text-stone-500 mt-1">{{ dates[selectedDateIndex].location }}</span> 
                    </div>
                </div>
                <div class="text-right text-xs text-stone-600 pl-3">
                    <span class="font-bold block text-earth-brown mb-1">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    
                    <span v-if="dates[selectedDateIndex].hasCar" class="inline-block bg-matcha-green/10 text-matcha-green px-2 py-1 rounded-lg font-bold">
                        <i class="fa-solid fa-car-side mr-1"></i> 租車自駕
                    </span>
                    <span v-else class="inline-block bg-slate-100 text-slate-500 px-2 py-1 rounded-lg font-bold">
                        <i class="fa-solid fa-train-subway mr-1"></i> 大眾運輸
                    </span>
                </div>
            </div>

            <div class="space-y-4">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                    
                    <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-stone-400">
                        <div class="h-6 w-0.5 bg-stone-200 absolute left-6 -top-3"></div>
                        <i :class="getTransportIcon(currentItinerary[idx].transportType)" 
                           class="mr-2 text-stone-300 cursor-pointer hover:text-maple-red transition-colors" 
                           @click="openMapDirections(currentItinerary[idx - 1], item)">
                        </i>
                        <span class="font-bold">{{ item.travelTime || '約 20 分鐘' }}</span>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-5 card-shadow relative overflow-hidden flex items-start border border-orange-100">
                        
                        <div class="mr-4 flex flex-col items-center min-w-[50px]">
                            <div class="p-2 rounded-full text-white shadow-md text-base mb-1" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-stone-500 mt-1">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 pb-1">
                            <h3 class="text-lg font-bold text-earth-brown mb-1 leading-tight pr-8">{{ item.name }}</h3>
                            
                            <div class="text-sm text-stone-500 space-y-1.5 mt-2">
                                <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-warm-orange"></i> {{ item.hours }}</p>
                                <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-warm-orange"></i> {{ item.price }}</p>
                                <p v-if="item.address" class="flex items-start"><i class="fa-solid fa-location-dot w-4 text-center mr-2 mt-1 text-warm-orange"></i> {{ item.address }}</p>
                            </div>

                            <div v-if="item.note && item.note.length > 0" class="mt-3 text-xs bg-autumn-cream p-2.5 rounded-lg border border-orange-100">
                                <p class="text-stone-600 font-bold mb-1 flex items-center">
                                    <i class="fa-solid fa-leaf text-matcha-green mr-2"></i> 筆記 / MapCode
                                </p>
                                <div class="note-content whitespace-pre-line" :class="{'expanded': item.isNoteExpanded}">{{ item.note }}</div>
                                <button v-if="item.note.length > 50" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-maple-red font-bold mt-1 block">
                                    {{ item.isNoteExpanded ? '收合' : '展開...' }}
                                </button>
                            </div>
                        </div>

                        <div class="absolute top-3 right-3 flex flex-col space-y-1">
                            <button v-if="idx > 0" @click.stop="moveItineraryUp(item.id)" class="w-7 h-7 bg-stone-100 text-stone-500 rounded-full flex items-center justify-center text-xs hover:bg-stone-200" title="上移"><i class="fa-solid fa-arrow-up"></i></button>
                            <button v-if="idx < currentItinerary.length - 1" @click.stop="moveItineraryDown(item.id)" class="w-7 h-7 bg-stone-100 text-stone-500 rounded-full flex items-center justify-center text-xs hover:bg-stone-200" title="下移"><i class="fa-solid fa-arrow-down"></i></button>
                            
                            <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-warm-orange/10 text-warm-orange rounded-full flex items-center justify-center text-xs hover:bg-warm-orange hover:text-white transition-colors" title="導航">
                                <i class="fa-solid fa-location-arrow"></i>
                            </button>
                            <button @click.stop="editItem(item)" class="w-7 h-7 bg-stone-100 text-stone-500 rounded-full flex items-center justify-center text-xs hover:bg-stone-200 transition-colors" title="編輯">
                                <i class="fa-solid fa-pencil"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="currentItinerary.length === 0" class="text-center py-16 text-stone-300">
                    <i class="fa-solid fa-map-location-dot text-5xl mb-3 text-stone-200"></i>
                    <p class="text-sm">本日尚無行程<br>請點擊右下角新增</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
            
            <div class="bg-gradient-to-r from-earth-brown to-stone-600 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                <div class="flex items-center justify-between space-x-3 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] text-orange-100 block mb-1 uppercase tracking-wider">JPY (日幣)</label>
                        <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold" placeholder="¥">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-orange-200 mt-5"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-orange-100 block mb-1 uppercase tracking-wider">TWD (台幣)</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2.5 text-white text-lg font-bold border border-transparent">
                            $ {{ currencyResult }}
                        </div>
                    </div>
                </div>
                <p class="text-[10px] text-orange-200 mt-3 text-right relative z-10">匯率基準: 0.20</p>
            </div>
           <div class="bg-white rounded-3xl p-5 card-shadow">
                <h3 class="font-bold text-earth-brown mb-3 border-b border-stone-100 pb-2">
                    <i class="fa-solid fa-cloud-arrow-up text-warm-orange mr-2"></i> 行程同步
                </h3>
                <p class="text-xs text-stone-400 mb-3">若要將您編輯過的行程傳給其他人，請點擊匯出。</p>
                <button @click="openSyncModal" class="w-full bg-stone-800 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-stone-700 transition-colors">
                    匯出 / 匯入 行程資料
                </button>
            </div> 
            <div class="bg-white rounded-3xl p-5 card-shadow">
                <h3 class="font-bold text-earth-brown mb-3 border-b border-stone-100 pb-2"><i class="fa-solid fa-plane-departure text-maple-red mr-2"></i> 航班資訊</h3>
                <div class="space-y-4">
                    <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                        <div class="flex justify-between text-sm font-bold text-earth-brown mb-1">
                            <span>TPE 台北</span> <i class="fa-solid fa-plane text-xs text-orange-400"></i> <span>FUK 福岡</span>
                        </div>
                        <div class="flex justify-between text-xs text-stone-500">
                            <span>08:00 (12/13)</span> <span>BR/CI?</span> <span>11:15</span>
                        </div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                        <div class="flex justify-between text-sm font-bold text-earth-brown mb-1">
                            <span>FUK 福岡</span> <i class="fa-solid fa-plane text-xs text-orange-400"></i> <span>TPE 台北</span>
                        </div>
                        <div class="flex justify-between text-xs text-stone-500">
                            <span>20:55 (12/21)</span> <span>BR/CI?</span> <span>22:40</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-earth-brown mb-4 border-b border-stone-100 pb-3"><i class="fa-solid fa-hotel text-gingko-gold mr-2"></i> 住宿資訊</h3>
                <ul class="space-y-5">
                    <li v-for="hotel in hotels" class="border-b last:border-0 pb-4 last:pb-0 border-stone-100">
                        <div class="flex justify-between items-start group">
                            <div class="flex-1">
                                <span class="font-bold block text-earth-brown text-lg">{{ hotel.name }}</span>
                                <span class="text-xs text-stone-400 bg-stone-100 px-2 py-0.5 rounded-full inline-block mt-1">{{ hotel.date }}</span>
                            </div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition-all"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <div class="text-sm text-stone-500 mt-2 space-y-1">
                            <p class="flex items-center"><i class="fa-solid fa-yen-sign w-4 text-center mr-2 text-stone-300"></i> {{ hotel.priceTWD }} (約 ¥{{ formatNumber(hotel.priceJPY) }})</p>
                            <p class="flex items-start"><i class="fa-solid fa-map-pin w-4 text-center mr-2 mt-1 text-stone-300"></i> {{ hotel.area }}</p>
                        </div>
                    </li>
                </ul>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-earth-brown mb-3 border-b border-stone-100 pb-3"><i class="fa-solid fa-car text-matcha-green mr-2"></i> 租車資訊</h3>
                <div class="text-sm space-y-3">
                    <div class="flex justify-between">
                        <span class="text-stone-500">期間</span>
                        <span class="font-bold text-earth-brown">12/13 12:00 - 12/18 20:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-stone-500">取車</span>
                        <span class="font-bold text-earth-brown text-right">天神渡邊通店</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-stone-500">MapCode</span>
                        <span class="font-bold text-earth-brown">13 318 076*06</span>
                    </div>
                    <button @click="openMap('天神渡邊通店')" class="w-full mt-4 bg-matcha-green/10 text-matcha-green py-3 rounded-xl text-sm font-bold hover:bg-matcha-green/20 transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-diamond-turn-right mr-2"></i> 導航去取車點
                    </button>
                </div>
            </div>
            
            <div class="bg-red-50 rounded-3xl p-6 border border-red-100">
                <h3 class="font-bold text-red-800 mb-4"><i class="fa-solid fa-kit-medical mr-2"></i> 緊急聯絡</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <a href="tel:110" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100">警察 110</a>
                    <a href="tel:119" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100">救護 119</a>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'shopping'" class="animate-fade-in">
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-2xl p-3 card-shadow relative group">
                    <div class="aspect-square bg-stone-50 rounded-xl mb-3 overflow-hidden relative border border-stone-100 flex items-center justify-center">
                        <i class="fa-solid fa-bag-shopping text-3xl text-stone-200"></i>
                        <button @click="removeShoppingItem(idx)" class="absolute top-2 right-2 bg-stone-800/60 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <p class="font-bold text-sm text-earth-brown truncate px-1">{{ item.name }}</p>
                </div>
                
                <div v-if="shoppingList.length === 0" class="col-span-2 text-center py-16 text-stone-300">
                    <i class="fa-solid fa-basket-shopping text-5xl mb-3 text-stone-200"></i>
                    <p class="text-sm">購物清單空白<br>請點擊右下角新增</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'expenses'" class="animate-fade-in">
            <div class="expenses-banner text-white rounded-3xl p-8 mb-6 relative overflow-hidden shadow-lg">
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                <div class="absolute -left-10 -bottom-10 bg-yellow-400/20 w-40 h-40 rounded-full blur-2xl"></div>
                <p class="text-sm text-orange-100 mb-2 relative z-10">預估總花費 (JPY)</p>
                <h2 class="text-5xl font-bold relative z-10 tracking-tight">¥ {{ formatNumber(totalExpensesJPY) }}</h2>
                <p class="text-sm text-right mt-2 opacity-80 relative z-10">約 NT$ {{ formatNumber(totalExpensesTWD) }}</p>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[500px] p-6 shadow-[0_-10px_40px_rgba(93,64,55,0.05)] -mx-4 px-8">
                <h3 class="font-bold text-earth-brown mb-5 flex items-center"><i class="fa-solid fa-receipt text-stone-300 mr-2"></i>支出紀錄</h3>
                <div class="space-y-5">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between border-b border-stone-50 pb-4 last:border-0">
                        <div class="flex items-center">
                            <div class="expense-category-tag mr-4 text-white" :class="getCategoryColor(exp.category)">
                                {{ getCategoryLabel(exp.category) }}
                            </div>
                            <div>
                                <p class="font-bold text-stone-700 text-sm mb-0.5">{{ exp.name }}</p>
                                <p class="text-[10px] text-stone-400 uppercase tracking-wide">{{ exp.date }}</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center">
                            <p class="font-bold text-stone-700">¥{{ formatNumber(exp.amount) }}</p>
                            <button @click="removeExpense(idx)" class="w-5 h-5 ml-3 text-red-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-gingko-gold rounded-full fab-shadow text-white text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div v-if="showModal" class="fixed inset-0 bg-stone-900/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            
            <div v-if="modalType === 'shopping'">
                <h3 class="font-bold text-lg mb-5 text-center text-earth-brown">新增購物清單</h3>
                <input v-model="newItem.name" type="text" placeholder="商品名稱" class="w-full bg-stone-50 border-none rounded-xl p-4 mb-6 focus:ring-2 focus:ring-warm-orange text-sm">
                <div class="flex space-x-3">
                    <button @click="showModal = false" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold text-sm">取消</button>
                    <button @click="saveShoppingItem" class="flex-1 py-3 rounded-xl bg-maple-red text-white font-bold text-sm shadow-lg">新增</button>
                </div>
            </div>

            <div v-if="modalType === 'expenses'">
                <h3 class="font-bold text-lg mb-5 text-center text-earth-brown">記一筆</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input v-model="newItem.date" type="date" class="bg-stone-50 rounded-xl p-3 text-sm text-stone-600 outline-none">
                    <select v-model="newItem.category" class="bg-stone-50 rounded-xl p-3 text-sm text-stone-600 outline-none">
                        <option value="food">飲食</option>
                        <option value="shopping">購物</option>
                        <option value="transport">交通</option>
                        <option value="stay">住宿</option>
                        <option value="ticket">門票</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <input v-model="newItem.name" placeholder="名稱" class="w-full bg-stone-50 rounded-xl p-4 mb-4 text-sm outline-none focus:ring-2 focus:ring-warm-orange">
                <div class="relative mb-6">
                    <span class="absolute left-4 top-4 text-stone-400 font-bold">¥</span>
                    <input v-model.number="newItem.amount" type="number" placeholder="金額" class="w-full bg-stone-50 rounded-xl p-4 pl-8 text-sm outline-none focus:ring-2 focus:ring-warm-orange font-bold text-lg">
                </div>
                <div class="flex space-x-3">
                    <button @click="showModal = false" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold text-sm">取消</button>
                    <button @click="saveExpenseItem" class="flex-1 py-3 rounded-xl bg-gingko-gold text-white font-bold text-sm shadow-lg">儲存</button>
                </div>
            </div>

            <div v-if="modalType === 'itinerary'">
                <h3 class="font-bold text-lg mb-5 text-center text-earth-brown">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-3">
                    <select v-model="newItem.category" class="w-full bg-stone-50 rounded-xl p-3 text-sm outline-none">
                        <option value="sightseeing">景點</option>
                        <option value="food">飲食</option>
                        <option value="shopping">購物</option>
                        <option value="accommodation">住宿</option>
                        <option value="flight">航班</option>
                        <option value="transport">交通</option>
                        <option value="other">其他</option>
                    </select>
                    <input v-model="newItem.name" placeholder="名稱" class="w-full bg-stone-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-warm-orange">
                    <input v-model="newItem.address" placeholder="地址/MapCode" class="w-full bg-stone-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-warm-orange">
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model="newItem.startTime" type="text" placeholder="時間 (09:00)" class="bg-stone-50 rounded-xl p-3 text-sm outline-none">
                        <select v-model="newItem.transportType" class="bg-stone-50 rounded-xl p-3 text-sm outline-none">
                            <option value="car">自駕</option>
                            <option value="walk">步行</option>
                            <option value="public">JR/巴士</option>
                            <option value="flight">飛機</option>
                        </select>
                    </div>
                    <textarea v-model="newItem.note" placeholder="備註/電話/導航資訊" rows="3" class="w-full bg-stone-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-warm-orange"></textarea>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button @click="showModal = false" class="py-3 rounded-xl bg-stone-100 text-stone-500 font-bold text-sm flex-1">取消</button>
                    <button v-if="isEditMode" @click="removeItineraryItem" class="py-3 rounded-xl bg-red-100 text-red-600 font-bold text-sm w-1/4"><i class="fa-solid fa-trash"></i></button>
                    <button @click="saveItineraryItem" class="py-3 rounded-xl bg-maple-red text-white font-bold text-sm shadow-lg flex-1">{{ isEditMode ? '儲存' : '新增' }}</button>
                </div>
            </div>

        </div>
    </div>
<div v-if="showSyncModal" class="fixed inset-0 bg-stone-900/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-center text-earth-brown">行程同步</h3>
            <p class="text-xs text-center text-stone-500 mb-5">複製代碼給朋友，或貼上朋友的代碼。</p>
            
            <textarea v-model="syncInput" rows="5" placeholder="在此貼上行程代碼..." class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-xs mb-4 focus:ring-2 focus:ring-warm-orange break-all"></textarea>
            
            <div class="grid grid-cols-2 gap-3">
                <button @click="copyDataToClipboard" class="py-3 rounded-xl bg-warm-orange text-white font-bold text-sm shadow-md">
                    <i class="fa-regular fa-copy mr-1"></i> 複製匯出
                </button>
                <button @click="importDataString" class="py-3 rounded-xl bg-matcha-green text-white font-bold text-sm shadow-md">
                    <i class="fa-solid fa-download mr-1"></i> 讀取匯入
                </button>
            </div>
            <button @click="showSyncModal = false" class="w-full mt-3 py-3 rounded-xl text-stone-400 font-bold text-sm hover:bg-stone-100">關閉</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // 基礎設定
            const EXCHANGE_RATE = 0.2; // 匯率設定
            const currentTab = ref('itinerary');
            const showModal = ref(false);
            const modalType = ref(''); // shopping, expenses, itinerary
            const isEditMode = ref(false);
            const selectedDateIndex = ref(0);
            
            // 貨幣計算
            const currencyInput = ref(10000);
            const currencyResult = ref(0);
            const calculateCurrency = () => currencyResult.value = Math.round(currencyInput.value * EXCHANGE_RATE);

            // 日期資料 (12/13 - 12/21)
            const dates = ref([
                { date: '12/13', weekday: '六', hasCar: true, location: '福岡 → 租車' },
                { date: '12/14', weekday: '日', hasCar: true, location: '福岡 → 熊本' },
                { date: '12/15', weekday: '一', hasCar: true, location: '熊本 → 高千穗 → 黑川' },
                { date: '12/16', weekday: '二', hasCar: true, location: '黑川 → 阿蘇 → 別府' },
                { date: '12/17', weekday: '三', hasCar: true, location: '別府 → 由布院' },
                { date: '12/18', weekday: '四', hasCar: true, location: '由布院 → 福岡 (還車)' },
                { date: '12/19', weekday: '五', hasCar: false, location: '福岡 (門司港/小倉)' },
                { date: '12/20', weekday: '六', hasCar: false, location: '福岡 (太宰府/市區)' },
                { date: '12/21', weekday: '日', hasCar: false, location: '福岡 → 返台' },
            ]);

            // 天氣資料 (預設秋/冬)
            const weatherData = ref([
                { condition: 'cloudy', temp: '12/5' }, // 12/13
                { condition: 'sunny', temp: '11/4' },  // 12/14
                { condition: 'sunny', temp: '8/-1' },  // 12/15 高山較冷
                { condition: 'cloudy', temp: '7/-2' }, // 12/16 阿蘇
                { condition: 'rain', temp: '9/3' },    // 12/17
                { condition: 'cloudy', temp: '10/4' }, // 12/18
                { condition: 'sunny', temp: '11/5' },  // 12/19
                { condition: 'sunny', temp: '12/6' },  // 12/20
                { condition: 'cloudy', temp: '12/6' }, // 12/21
            ]);

            // 住宿資料
            const hotels = ref([
                { name: 'Cross Life 博多柳橋', date: '12/13 (1晚)', priceTWD: 'NT$21,246', priceJPY: 98818, area: '福岡' },
                { name: 'Hotel Nikko Kumamoto', date: '12/14 (1晚)', priceTWD: 'NT$9,694', priceJPY: 45088, area: '熊本' },
                { name: '山しのぶ (黑川溫泉)', date: '12/15 (1晚)', priceTWD: 'NT$27,407', priceJPY: 127474, area: '黑川' },
                { name: 'AMANEK BEPPU YULA-RE', date: '12/16-18 (2晚)', priceTWD: 'NT$27,914', priceJPY: 129832, area: '別府' },
                { name: 'Tokyu Stay Fukuoka Tenjin', date: '12/18-21 (3晚)', priceTWD: 'NT$60,134', priceJPY: 279693, area: '福岡天神' },
            ]);

            // 購物與花費 (範例)
            const shoppingList = ref([
                { name: '福岡明太子' }, { name: '努努雞' }, { name: '熊本熊周邊' }, { name: '由布院 B-Speak 蛋糕捲' }, { name: '藥妝 (合利他命)' }
            ]);
            
            // 預先載入住宿費到花費列表
            const expenses = ref([
                { name: 'Cross Life 博多', amount: 98818, category: 'stay', date: '2025-12-13' },
                { name: '日航熊本', amount: 45088, category: 'stay', date: '2025-12-14' },
                { name: '山しのぶ', amount: 127474, category: 'stay', date: '2025-12-15' },
                { name: 'AMANEK 別府', amount: 129832, category: 'stay', date: '2025-12-16' },
                { name: 'Tokyu Stay 天神', amount: 279693, category: 'stay', date: '2025-12-18' },
            ]);

 // --- 行程資料 (已更新：依據九州實際路況估算交通時間) ---
            const itineraryData = ref([
                // Day 1: 12/13 (六) 福岡抵達
                [
                    { id: 101, category: 'flight', startTime: '06:00', hours: '08:00 - 11:15', name: '前往機場 (桃園 TPE)', note: '飛機 08:00 TPE ~ 11:15 FUK ', transportType: 'flight' },
                    { id: 102, category: 'transport', startTime: '10:00', hours: '10:00 - 11:00', name: '抵達福岡 & 放行李', address: 'Cross Life 博多柳橋', note: '機場搭地鐵往市區 (渡邊通站) ', transportType: 'public', travelTime: '約 30 分鐘 (地鐵)' },
                    { id: 103, category: 'food', startTime: '13:00', hours: '13:00 - 14:00', name: '午餐: The Full Full Hakata', note: '明太子法國麵包 ', transportType: 'walk', travelTime: '約 15 分鐘 (步行)' },
                    { id: 104, category: 'sightseeing', startTime: '14:00', hours: '14:00 - 16:00', name: '福岡市區逛街', note: '博多運河城 (MUJI、一番賞)、櫛田神社、麵包超人博物館 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 105, category: 'food', startTime: '17:00', hours: '17:00 - 18:00', name: '晚餐: 華美鳥水炊鍋', note: '已預約 17:00 ', transportType: 'walk', travelTime: '約 15 分鐘 (步行)' },
                    { id: 106, category: 'food', startTime: '19:00', hours: '19:00 - 20:00', name: '宵夜: ShinShin / 大砲 / 屋台', note: '推薦拉麵與屋台體驗 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                ],
                // Day 2: 12/14 (日) 福岡 -> 熊本 (開始自駕)
                [
                    { id: 201, category: 'transport', startTime: '08:00', hours: '08:00 - 09:00', name: '租車 (天神渡邊通店)', address: '天神渡邊通店', note: 'Mapcode: 13 318 076*06\n08:00 取車 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 202, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 11:00', name: '開車行程 (賞楓/銀杏)', note: '太原銀杏森林 (37 292 372*68)\n秋月城跡 (55 173 471*74) ', transportType: 'car', travelTime: '約 50 分鐘 (車)' },
                    { id: 203, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 勝烈亭 豬排', note: 'Mapcode: 29 459 389*34 ', transportType: 'car', travelTime: '約 90 分鐘 (高速)' },
                    { id: 204, category: 'sightseeing', startTime: '14:00', hours: '14:00 - 15:00', name: '熊本城 + 城彩苑', note: 'Mapcode: 29 489 329*60 ', transportType: 'walk', travelTime: '約 10 分鐘 (車)' },
                    { id: 205, category: 'shopping', startTime: '15:00', hours: '15:00 - 16:00', name: '市區逛街 & 喫茶室', note: '上下通商店街、長崎次郎喫茶室 (29 458 566*01) ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 206, category: 'food', startTime: '18:00', hours: '18:00 - 19:30', name: '晚餐: 和牛塔卡 (LIEBE)', note: '已訂位 18:30\nMapcode: 29 460 452*38 ', transportType: 'car', travelTime: '約 15 分鐘 (車)' },
                    { id: 207, category: 'accommodation', startTime: '20:00', name: '住宿: 日航熊本', note: 'Mapcode: 29 490 018*61 ', transportType: 'car', travelTime: '約 10 分鐘 (車)' }
                ],
                // Day 3: 12/15 (一) 熊本 -> 高千穗 -> 黑川 (山路多)
                [
                    { id: 301, category: 'other', startTime: '06:00', name: '備註: 確認高千穗划船狀況', note: '確認運行狀況 ', transportType: 'car' },
                    { id: 302, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 10:30', name: '天岩戶神社', note: 'Mapcode: 330 837 641*24 ', transportType: 'car', travelTime: '約 1小時45分 (山路)' },
                    { id: 303, category: 'food', startTime: '11:00', hours: '11:00 - 12:00', name: '午餐: 高千穗牛_和', note: 'Mapcode: 330 742 450*53 ', transportType: 'car', travelTime: '約 15 分鐘 (車)' },
                    { id: 304, category: 'sightseeing', startTime: '12:00', hours: '12:00 - 13:00', name: '高千穗峽 (划船)', note: '預約 12:00\nMapcode: 330 711 671*87 ', transportType: 'car', travelTime: '約 10 分鐘 (車)' },
                    { id: 305, category: 'transport', startTime: '13:00', hours: '13:00 - 14:30', name: '前往上色見', note: '約 1 小時車程 ', transportType: 'car', travelTime: '約 55 分鐘 (山路)' },
                    { id: 306, category: 'sightseeing', startTime: '14:30', hours: '14:30 - 15:30', name: '上色見熊野座神社', note: 'Mapcode: 256 379 371*35 ', transportType: 'car', travelTime: '抵達即開始' },
                    { id: 307, category: 'food', startTime: '18:00', hours: '18:00 - 19:00', name: '晚餐: 飯店懷石料理', note: '18:30 用餐 ', transportType: 'car', travelTime: '約 50 分鐘 (往黑川)' },
                    { id: 308, category: 'sightseeing', startTime: '19:00', hours: '19:00 - 20:00', name: '黑川溫泉街散策', note: '推薦: Patisserie Roku 泡芙 ', transportType: 'walk', travelTime: 'Check-in 後步行' },
                    { id: 309, category: 'accommodation', startTime: '20:00', name: '住宿: 山しのぶ', note: 'Mapcode: 440 540 236*68 ', transportType: 'car', travelTime: '位於溫泉區旁' }
                ],
                // Day 4: 12/16 (二) 黑川 -> 阿蘇 -> 別府 (最美公路)
                [
                    { id: 401, category: 'other', startTime: '06:00', name: '備註: 確認阿蘇火山開放', note: '確認開放狀況 ', transportType: 'car' },
                    { id: 402, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 11:00', name: '阿蘇火山口', note: '可搭直升機\nMapcode: 256 460 704*02 ', transportType: 'car', travelTime: '約 50 分鐘 (山路)' },
                    { id: 403, category: 'sightseeing', startTime: '12:00', hours: '12:00 - 13:30', name: '午餐 & 草千里', note: '騎馬/散步 ', transportType: 'car', travelTime: '約 5 分鐘 (車)' },
                    { id: 404, category: 'sightseeing', startTime: '14:00', hours: '14:00 - 15:00', name: '阿蘇神社', note: '吃阿蘇牛奶、泡芙\nMapcode: 256 704 305*31 ', transportType: 'car', travelTime: '約 25 分鐘 (下山)' },
                    { id: 405, category: 'transport', startTime: '15:00', hours: '15:00 - 17:00', name: '前往別府', note: '途經 九重夢大橋 / 長者原道標 ', transportType: 'car', travelTime: '約 90 分鐘 (山脈公路)' },
                    { id: 406, category: 'food', startTime: '17:00', hours: '17:00 - 18:00', name: '晚餐: 天婦羅 とよ常', note: 'Mapcode: 46 405 225*67 ', transportType: 'car', travelTime: '抵達別府市區' },
                    { id: 407, category: 'accommodation', startTime: '19:00', name: '住宿: AMANEK BEPPU', note: 'Mapcode: 46 405 228*51 ', transportType: 'car', travelTime: '約 5 分鐘 (車)' }
                ],
                // Day 5: 12/17 (三) 別府/由布院 (注意折返跑)
                [
                    { id: 501, category: 'food', startTime: '07:00', hours: '07:00 - 08:30', name: '早餐: Cafe La Ruche', note: '金鱗湖畔\nMapcode: 269 359 616*04 ', transportType: 'car', travelTime: '約 40 分鐘 (別府往由布院)' },
                    { id: 502, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 10:30', name: '別府地獄巡遊', note: '吃地獄蒸布丁\nMapcode: 46 521 469*64 ', transportType: 'car', travelTime: '約 35 分鐘 (折返別府)' },
                    { id: 503, category: 'sightseeing', startTime: '10:30', hours: '10:30 - 11:30', name: '狭霧台 (眺望由布院)', note: 'Mapcode: 46 301 725*70 ', transportType: 'car', travelTime: '約 15 分鐘 (山路)' },
                    { id: 504, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 布釜飯 / 蕎麥麵', note: '由布まぶし 心 或 手打蕎麥麵 泉 ', transportType: 'car', travelTime: '約 15 分鐘 (下山)' },
                    { id: 505, category: 'sightseeing', startTime: '13:00', hours: '13:00 - 15:30', name: '由布院散策', note: '金鱗湖、花卉村、B-speak ', transportType: 'walk', travelTime: '步行逛街' },
                    { id: 506, category: 'food', startTime: '17:00', hours: '17:00 - 18:30', name: '晚餐: 海鮮いづつ', note: '別府市區海鮮\nMapcode: 46 375 716*53 ', transportType: 'car', travelTime: '約 45 分鐘 (回別府)' },
                    { id: 507, category: 'sightseeing', startTime: '19:00', hours: '19:00 - 20:00', name: '湯霧展望台 (夜景)', note: 'Mapcode: 46 523 435*11 ', transportType: 'car', travelTime: '約 15 分鐘 (車)' },
                    { id: 508, category: 'accommodation', startTime: '20:30', name: '住宿: AMANEK BEPPU', note: '續住 ', transportType: 'car', travelTime: '約 15 分鐘 (下山)' }
                ],
                // Day 6: 12/18 (四) 別府 -> 動物園 -> 福岡
                [
                    { id: 601, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 13:00', name: '九州自然動物園', note: 'Mapcode: 46 634 658*87\n叢林巴士 ', transportType: 'car', travelTime: '約 30 分鐘 (車)' },
                    { id: 602, category: 'sightseeing', startTime: '13:00', hours: '13:00 - 14:00', name: '別府纜車 (備選)', note: 'Mapcode: 46 369 844*81 ', transportType: 'car', travelTime: '約 25 分鐘 (車)' },
                    { id: 603, category: 'transport', startTime: '14:00', hours: '14:00 - 16:30', name: '開車返回福岡', note: '返回市區 ', transportType: 'car', travelTime: '約 2 小時 (高速)' },
                    { id: 604, category: 'transport', startTime: '17:00', hours: '17:00 - 18:00', name: '還車 (天神渡邊通店)', note: '20:00 前需還車 ', transportType: 'car', travelTime: '市區塞車緩衝' },
                    { id: 605, category: 'food', startTime: '18:00', hours: '18:00 - 20:00', name: '晚餐: 博多牛腸鍋', note: '天神周邊自由覓食 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 606, category: 'accommodation', startTime: '20:00', name: '住宿: Tokyu Stay 天神', note: 'Mapcode: 13 318 296*24 ', transportType: 'walk', travelTime: '約 5 分鐘 (步行)' }
                ],
                // Day 7: 12/19 (五) 門司港 (大眾運輸)
                [
                    { id: 701, category: 'transport', startTime: '08:00', hours: '08:00 - 09:30', name: '前往門司港 (JR)', note: '博多 > 小倉 > 門司港 ', transportType: 'public', travelTime: '約 10 分鐘 (地鐵)' },
                    { id: 702, category: 'sightseeing', startTime: '10:00', hours: '10:00 - 12:00', name: '門司港懷舊區', note: '車站、舊門司稅關、藍翼橋 ', transportType: 'walk', travelTime: '約 50 分鐘 (JR特急)' },
                    { id: 703, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 伽哩本舖', note: '燒咖哩 ', transportType: 'walk', travelTime: '約 5 分鐘 (步行)' },
                    { id: 704, category: 'sightseeing', startTime: '13:00', hours: '13:00 - 15:00', name: '小倉城 / 勝山公園', note: '賞楓 ', transportType: 'public', travelTime: '約 20 分鐘 (JR)' },
                    { id: 705, category: 'food', startTime: '18:00', hours: '18:00 - 19:30', name: '晚餐: 鰻魚 田舍庵', note: '小倉百年老店 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 706, category: 'accommodation', startTime: '20:00', name: '住宿: Tokyu Stay 天神', note: '續住 ', transportType: 'public', travelTime: '約 50 分鐘 (JR/新幹線)' }
                ],
                // Day 8: 12/20 (六) 太宰府 (大眾運輸)
                [
                    { id: 801, category: 'sightseeing', startTime: '09:00', hours: '09:00 - 11:00', name: '太宰府天滿宮', note: '光明禪寺、梅枝餅 ', transportType: 'public', travelTime: '約 45 分鐘 (西鐵巴士/電車)' },
                    { id: 802, category: 'food', startTime: '12:00', hours: '12:00 - 13:00', name: '午餐: 明太子 神樂', note: '神楽 (かぐら) ', transportType: 'walk', travelTime: '參道步行' },
                    { id: 803, category: 'shopping', startTime: '14:00', hours: '14:00 - 17:00', name: 'TeamLab / 福岡塔', note: '沈浸式光影展 / 逛街 ', transportType: 'public', travelTime: '約 50 分鐘 (巴士直達)' },
                    { id: 804, category: 'food', startTime: '18:00', hours: '18:00 - 19:30', name: '晚餐: 燒肉 上', note: 'Yakiniku Jo ', transportType: 'walk', travelTime: '約 20 分鐘 (巴士)' },
                    { id: 805, category: 'accommodation', startTime: '20:00', name: '住宿: Tokyu Stay 天神', note: '續住 ', transportType: 'walk', travelTime: '約 15 分鐘 (步行)' }
                ],
                // Day 9: 12/21 (日) 返台
                [
                    { id: 901, category: 'food', startTime: '06:00', hours: '06:00 - 08:00', name: '早餐巡禮', note: '大砲/一双/ShinShin ', transportType: 'walk', travelTime: '起床出發' },
                    { id: 902, category: 'food', startTime: '08:00', hours: '08:00 - 10:00', name: 'I\'m donut? / Dacomecca', note: '排隊名店 ', transportType: 'walk', travelTime: '約 10 分鐘 (步行)' },
                    { id: 903, category: 'sightseeing', startTime: '10:00', hours: '10:00 - 12:00', name: '大濠公園 & LOCALS', note: '最後採買 (努努雞) ', transportType: 'walk', travelTime: '約 20 分鐘 (地鐵)' },
                    { id: 904, category: 'food', startTime: '12:30', hours: '12:30 - 14:00', name: '午餐: 人形町今半', note: '壽喜燒 ', transportType: 'walk', travelTime: '約 20 分鐘 (地鐵)' },
                    { id: 905, category: 'transport', startTime: '17:00', name: '前往機場 (FUK)', note: '準備返台 ', transportType: 'public', travelTime: '約 30 分鐘 (地鐵)' },
                    { id: 906, category: 'flight', startTime: '20:55', name: '飛機起飛', note: '20:55 FUK ~ TPE ', transportType: 'flight', travelTime: 'Check-in 等候' }
                ]
            ]);
            
            // Computed
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const totalExpensesJPY = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
            const totalExpensesTWD = computed(() => Math.round(totalExpensesJPY.value * EXCHANGE_RATE));

            // 通用變數
            const newItem = ref({ name: '', amount: null, date: '', category: 'food', startTime: '', note: '' });

            // Methods
            const handleAddClick = () => {
                modalType.value = currentTab.value;
                newItem.value = { name: '', amount: null, date: dates.value[selectedDateIndex.value].date, category: 'food', startTime: '', note: '', transportType: 'walk' };
                isEditMode.value = false;
                showModal.value = true;
            };

            const saveShoppingItem = () => {
                if(newItem.value.name) shoppingList.value.push({...newItem.value});
                showModal.value = false;
            };
            const removeShoppingItem = (idx) => shoppingList.value.splice(idx, 1);
            
            const saveExpenseItem = () => {
                if(newItem.value.name && newItem.value.amount) expenses.value.push({...newItem.value});
                showModal.value = false;
            };
            const removeExpense = (idx) => expenses.value.splice(idx, 1);

            const saveItineraryItem = () => {
                const list = itineraryData.value[selectedDateIndex.value];
                if(isEditMode.value && newItem.value.id) {
                    const idx = list.findIndex(i => i.id === newItem.value.id);
                    if(idx !== -1) list[idx] = {...newItem.value};
                } else {
                    list.push({...newItem.value, id: Date.now()});
                }
                showModal.value = false;
            };
            const editItem = (item) => {
                newItem.value = JSON.parse(JSON.stringify(item));
                modalType.value = 'itinerary';
                isEditMode.value = true;
                showModal.value = true;
            };
            const removeItineraryItem = () => {
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === newItem.value.id);
                if(idx !== -1) list.splice(idx, 1);
                showModal.value = false;
            };

            const moveItineraryUp = (id) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === id);
                if(idx > 0) {
                    const temp = list[idx];
                    list[idx] = list[idx-1];
                    list[idx-1] = temp;
                }
            };
            const moveItineraryDown = (id) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === id);
                if(idx < list.length - 1) {
                    const temp = list[idx];
                    list[idx] = list[idx+1];
                    list[idx+1] = temp;
                }
            };

            // Helpers
            const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
           // 修正後的地圖功能
            
            // 1. 單點導航：搜尋地點 (預設從使用者目前位置導航)
            const openMap = (q) => {
                if (!q) return;
                // 使用 Google Maps 官方 Search API
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            };

            // 2. 區間導航：自動帶入「起點」與「終點」並選擇交通方式
            const openMapDirections = (startItem, endItem) => {
                if (!startItem || !endItem) return;

                // 優先使用地址，如果沒有地址則使用名稱
                const origin = startItem.address || startItem.name;
                const destination = endItem.address || endItem.name;

                // 轉換交通方式對應 Google Maps 的參數
                // car -> driving, walk -> walking, public -> transit
                let mode = 'driving'; 
                if (endItem.transportType === 'walk') mode = 'walking';
                if (endItem.transportType === 'public' || endItem.transportType === 'flight') mode = 'transit';

                // 組合 Google Maps Directions API 網址
                const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${mode}`;
                
                window.open(url, '_blank');
            };

            // 圖示與樣式對應
            const getCategoryColor = (c) => ({
                sightseeing: 'bg-matcha-green', food: 'bg-maple-red', shopping: 'bg-gingko-gold',
                accommodation: 'bg-stone-600', flight: 'bg-blue-500', transport: 'bg-warm-orange', other: 'bg-stone-400'
            }[c] || 'bg-stone-400');
            
            const getCategoryIcon = (c) => ({
                sightseeing: 'fa-solid fa-camera', food: 'fa-solid fa-utensils', shopping: 'fa-solid fa-bag-shopping',
                accommodation: 'fa-solid fa-bed', flight: 'fa-solid fa-plane', transport: 'fa-solid fa-car', other: 'fa-solid fa-info'
            }[c] || 'fa-solid fa-circle');

            const getCategoryLabel = (c) => ({ sightseeing: '景點', food: '美食', shopping: '購物', stay: '住宿', transport: '交通' }[c] || '其他');

            const getWeatherIcon = (c) => ({
                sunny: 'fa-solid fa-sun', cloudy: 'fa-solid fa-cloud', rain: 'fa-solid fa-umbrella', snow: 'fa-solid fa-snowflake'
            }[c] || 'fa-solid fa-cloud');
            
            const getWeatherDescription = (c) => ({ sunny: '晴朗', cloudy: '多雲', rain: '有雨', snow: '降雪' }[c] || '未知');

            const getTransportIcon = (t) => ({
                car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking', public: 'fa-solid fa-train', flight: 'fa-solid fa-plane'
            }[t] || 'fa-solid fa-arrow-right');

            onMounted(() => {
                calculateCurrency();
            });

            return {
                currentTab, dates, selectedDateIndex, currentItinerary, hotels, shoppingList, expenses,
                weatherData, currencyInput, currencyResult, calculateCurrency, totalExpensesJPY, totalExpensesTWD,
                showModal, modalType, isEditMode, newItem,
                handleAddClick, saveShoppingItem, removeShoppingItem, saveExpenseItem, removeExpense,
                saveItineraryItem, editItem, removeItineraryItem, moveItineraryUp, moveItineraryDown,
                formatNumber, openMap, openMapDirections,
                getCategoryColor, getCategoryIcon, getCategoryLabel, getWeatherIcon, getWeatherDescription, getTransportIcon
            };
        }
    }).mount('#app');
</script>
</body>

</html>
